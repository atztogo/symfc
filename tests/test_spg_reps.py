"""Tests of SpgReps class."""
import numpy as np
from phonopy import Phonopy
from phonopy.structure.atoms import PhonopyAtoms
from scipy.sparse import coo_array

from symfc.spg_reps import SpgReps


def test_translation_permutations_NaCl_111(cell_nacl_111: PhonopyAtoms):
    """Test SpgReps.translation_permutations."""
    cell = cell_nacl_111
    sym_reps = SpgReps(cell)
    trans_perms = sym_reps.translation_permutations
    # for v in trans_perms:
    #     print("[", ", ".join([f"{x}" for x in v]), "],")
    perms_ref = [
        [0, 1, 2, 3, 4, 5, 6, 7],
        [3, 2, 1, 0, 7, 6, 5, 4],
        [2, 3, 0, 1, 6, 7, 4, 5],
        [1, 0, 3, 2, 5, 4, 7, 6],
    ]
    done = []
    for tperm in trans_perms:
        for i, perm in enumerate(perms_ref):
            if np.array_equal(tperm, perm):
                done.append(i)
                break
    np.testing.assert_array_equal(np.sort(done), [0, 1, 2, 3])


def test_translation_permutations_shape_GaN_222(ph_gan_222: Phonopy):
    """Test SpgReps.translation_permutations."""
    cell = ph_gan_222.supercell
    sym_reps = SpgReps(cell)
    trans_perms = sym_reps.translation_permutations
    assert trans_perms.shape == (8, 32)


def test_get_fc2_reps_GaN_111(ph_gan_222: Phonopy):
    cell = ph_gan_222.unitcell
    sym_reps = SpgReps(cell)
    for i, (r, perm) in enumerate(zip(sym_reps._rotations, sym_reps._permutations)):
        if (r == [[1, -1, 0], [1, 0, 0], [0, 0, 1]]).all() and (
            perm == [1, 0, 3, 2]
        ).all():
            reps = sym_reps.get_fc2_rep(i)
            break
    array_ref = [
        [45, 0, 0.25],
        [45, 1, -0.4330127024898145],
        [46, 0, 0.4330127012946242],
        [46, 1, 0.25000000000000006],
        [47, 2, 0.5],
        [36, 9, 0.25],
        [36, 10, -0.4330127024898145],
        [37, 9, 0.4330127012946242],
        [37, 10, 0.25000000000000006],
        [38, 11, 0.5],
        [63, 18, 0.25],
        [63, 19, -0.4330127024898145],
        [64, 18, 0.4330127012946242],
        [64, 19, 0.25000000000000006],
        [65, 20, 0.5],
        [54, 27, 0.25],
        [54, 28, -0.4330127024898145],
        [55, 27, 0.4330127012946242],
        [55, 28, 0.25000000000000006],
        [56, 29, 0.5],
        [45, 3, -0.4330127024898145],
        [45, 4, 0.7500000020701304],
        [46, 3, -0.7500000000000001],
        [46, 4, -0.4330127024898146],
        [47, 5, -0.866025404979629],
        [36, 12, -0.4330127024898145],
        [36, 13, 0.7500000020701304],
        [37, 12, -0.7500000000000001],
        [37, 13, -0.4330127024898146],
        [38, 14, -0.866025404979629],
        [63, 21, -0.4330127024898145],
        [63, 22, 0.7500000020701304],
        [64, 21, -0.7500000000000001],
        [64, 22, -0.4330127024898146],
        [65, 23, -0.866025404979629],
        [54, 30, -0.4330127024898145],
        [54, 31, 0.7500000020701304],
        [55, 30, -0.7500000000000001],
        [55, 31, -0.4330127024898146],
        [56, 32, -0.866025404979629],
        [48, 0, 0.4330127012946242],
        [48, 1, -0.7500000000000001],
        [49, 0, 0.7499999979298698],
        [49, 1, 0.4330127012946243],
        [50, 2, 0.8660254025892484],
        [39, 9, 0.4330127012946242],
        [39, 10, -0.7500000000000001],
        [40, 9, 0.7499999979298698],
        [40, 10, 0.4330127012946243],
        [41, 11, 0.8660254025892484],
        [66, 18, 0.4330127012946242],
        [66, 19, -0.7500000000000001],
        [67, 18, 0.7499999979298698],
        [67, 19, 0.4330127012946243],
        [68, 20, 0.8660254025892484],
        [57, 27, 0.4330127012946242],
        [57, 28, -0.7500000000000001],
        [58, 27, 0.7499999979298698],
        [58, 28, 0.4330127012946243],
        [59, 29, 0.8660254025892484],
        [48, 3, 0.25000000000000006],
        [48, 4, -0.4330127024898146],
        [49, 3, 0.4330127012946243],
        [49, 4, 0.2500000000000001],
        [50, 5, 0.5000000000000001],
        [39, 12, 0.25000000000000006],
        [39, 13, -0.4330127024898146],
        [40, 12, 0.4330127012946243],
        [40, 13, 0.2500000000000001],
        [41, 14, 0.5000000000000001],
        [66, 21, 0.25000000000000006],
        [66, 22, -0.4330127024898146],
        [67, 21, 0.4330127012946243],
        [67, 22, 0.2500000000000001],
        [68, 23, 0.5000000000000001],
        [57, 30, 0.25000000000000006],
        [57, 31, -0.4330127024898146],
        [58, 30, 0.4330127012946243],
        [58, 31, 0.2500000000000001],
        [59, 32, 0.5000000000000001],
        [51, 6, 0.5],
        [51, 7, -0.866025404979629],
        [52, 6, 0.8660254025892484],
        [52, 7, 0.5000000000000001],
        [53, 8, 1.0],
        [42, 15, 0.5],
        [42, 16, -0.866025404979629],
        [43, 15, 0.8660254025892484],
        [43, 16, 0.5000000000000001],
        [44, 17, 1.0],
        [69, 24, 0.5],
        [69, 25, -0.866025404979629],
        [70, 24, 0.8660254025892484],
        [70, 25, 0.5000000000000001],
        [71, 26, 1.0],
        [60, 33, 0.5],
        [60, 34, -0.866025404979629],
        [61, 33, 0.8660254025892484],
        [61, 34, 0.5000000000000001],
        [62, 35, 1.0],
        [9, 36, 0.25],
        [9, 37, -0.4330127024898145],
        [10, 36, 0.4330127012946242],
        [10, 37, 0.25000000000000006],
        [11, 38, 0.5],
        [0, 45, 0.25],
        [0, 46, -0.4330127024898145],
        [1, 45, 0.4330127012946242],
        [1, 46, 0.25000000000000006],
        [2, 47, 0.5],
        [27, 54, 0.25],
        [27, 55, -0.4330127024898145],
        [28, 54, 0.4330127012946242],
        [28, 55, 0.25000000000000006],
        [29, 56, 0.5],
        [18, 63, 0.25],
        [18, 64, -0.4330127024898145],
        [19, 63, 0.4330127012946242],
        [19, 64, 0.25000000000000006],
        [20, 65, 0.5],
        [9, 39, -0.4330127024898145],
        [9, 40, 0.7500000020701304],
        [10, 39, -0.7500000000000001],
        [10, 40, -0.4330127024898146],
        [11, 41, -0.866025404979629],
        [0, 48, -0.4330127024898145],
        [0, 49, 0.7500000020701304],
        [1, 48, -0.7500000000000001],
        [1, 49, -0.4330127024898146],
        [2, 50, -0.866025404979629],
        [27, 57, -0.4330127024898145],
        [27, 58, 0.7500000020701304],
        [28, 57, -0.7500000000000001],
        [28, 58, -0.4330127024898146],
        [29, 59, -0.866025404979629],
        [18, 66, -0.4330127024898145],
        [18, 67, 0.7500000020701304],
        [19, 66, -0.7500000000000001],
        [19, 67, -0.4330127024898146],
        [20, 68, -0.866025404979629],
        [12, 36, 0.4330127012946242],
        [12, 37, -0.7500000000000001],
        [13, 36, 0.7499999979298698],
        [13, 37, 0.4330127012946243],
        [14, 38, 0.8660254025892484],
        [3, 45, 0.4330127012946242],
        [3, 46, -0.7500000000000001],
        [4, 45, 0.7499999979298698],
        [4, 46, 0.4330127012946243],
        [5, 47, 0.8660254025892484],
        [30, 54, 0.4330127012946242],
        [30, 55, -0.7500000000000001],
        [31, 54, 0.7499999979298698],
        [31, 55, 0.4330127012946243],
        [32, 56, 0.8660254025892484],
        [21, 63, 0.4330127012946242],
        [21, 64, -0.7500000000000001],
        [22, 63, 0.7499999979298698],
        [22, 64, 0.4330127012946243],
        [23, 65, 0.8660254025892484],
        [12, 39, 0.25000000000000006],
        [12, 40, -0.4330127024898146],
        [13, 39, 0.4330127012946243],
        [13, 40, 0.2500000000000001],
        [14, 41, 0.5000000000000001],
        [3, 48, 0.25000000000000006],
        [3, 49, -0.4330127024898146],
        [4, 48, 0.4330127012946243],
        [4, 49, 0.2500000000000001],
        [5, 50, 0.5000000000000001],
        [30, 57, 0.25000000000000006],
        [30, 58, -0.4330127024898146],
        [31, 57, 0.4330127012946243],
        [31, 58, 0.2500000000000001],
        [32, 59, 0.5000000000000001],
        [21, 66, 0.25000000000000006],
        [21, 67, -0.4330127024898146],
        [22, 66, 0.4330127012946243],
        [22, 67, 0.2500000000000001],
        [23, 68, 0.5000000000000001],
        [15, 42, 0.5],
        [15, 43, -0.866025404979629],
        [16, 42, 0.8660254025892484],
        [16, 43, 0.5000000000000001],
        [17, 44, 1.0],
        [6, 51, 0.5],
        [6, 52, -0.866025404979629],
        [7, 51, 0.8660254025892484],
        [7, 52, 0.5000000000000001],
        [8, 53, 1.0],
        [33, 60, 0.5],
        [33, 61, -0.866025404979629],
        [34, 60, 0.8660254025892484],
        [34, 61, 0.5000000000000001],
        [35, 62, 1.0],
        [24, 69, 0.5],
        [24, 70, -0.866025404979629],
        [25, 69, 0.8660254025892484],
        [25, 70, 0.5000000000000001],
        [26, 71, 1.0],
        [117, 72, 0.25],
        [117, 73, -0.4330127024898145],
        [118, 72, 0.4330127012946242],
        [118, 73, 0.25000000000000006],
        [119, 74, 0.5],
        [108, 81, 0.25],
        [108, 82, -0.4330127024898145],
        [109, 81, 0.4330127012946242],
        [109, 82, 0.25000000000000006],
        [110, 83, 0.5],
        [135, 90, 0.25],
        [135, 91, -0.4330127024898145],
        [136, 90, 0.4330127012946242],
        [136, 91, 0.25000000000000006],
        [137, 92, 0.5],
        [126, 99, 0.25],
        [126, 100, -0.4330127024898145],
        [127, 99, 0.4330127012946242],
        [127, 100, 0.25000000000000006],
        [128, 101, 0.5],
        [117, 75, -0.4330127024898145],
        [117, 76, 0.7500000020701304],
        [118, 75, -0.7500000000000001],
        [118, 76, -0.4330127024898146],
        [119, 77, -0.866025404979629],
        [108, 84, -0.4330127024898145],
        [108, 85, 0.7500000020701304],
        [109, 84, -0.7500000000000001],
        [109, 85, -0.4330127024898146],
        [110, 86, -0.866025404979629],
        [135, 93, -0.4330127024898145],
        [135, 94, 0.7500000020701304],
        [136, 93, -0.7500000000000001],
        [136, 94, -0.4330127024898146],
        [137, 95, -0.866025404979629],
        [126, 102, -0.4330127024898145],
        [126, 103, 0.7500000020701304],
        [127, 102, -0.7500000000000001],
        [127, 103, -0.4330127024898146],
        [128, 104, -0.866025404979629],
        [120, 72, 0.4330127012946242],
        [120, 73, -0.7500000000000001],
        [121, 72, 0.7499999979298698],
        [121, 73, 0.4330127012946243],
        [122, 74, 0.8660254025892484],
        [111, 81, 0.4330127012946242],
        [111, 82, -0.7500000000000001],
        [112, 81, 0.7499999979298698],
        [112, 82, 0.4330127012946243],
        [113, 83, 0.8660254025892484],
        [138, 90, 0.4330127012946242],
        [138, 91, -0.7500000000000001],
        [139, 90, 0.7499999979298698],
        [139, 91, 0.4330127012946243],
        [140, 92, 0.8660254025892484],
        [129, 99, 0.4330127012946242],
        [129, 100, -0.7500000000000001],
        [130, 99, 0.7499999979298698],
        [130, 100, 0.4330127012946243],
        [131, 101, 0.8660254025892484],
        [120, 75, 0.25000000000000006],
        [120, 76, -0.4330127024898146],
        [121, 75, 0.4330127012946243],
        [121, 76, 0.2500000000000001],
        [122, 77, 0.5000000000000001],
        [111, 84, 0.25000000000000006],
        [111, 85, -0.4330127024898146],
        [112, 84, 0.4330127012946243],
        [112, 85, 0.2500000000000001],
        [113, 86, 0.5000000000000001],
        [138, 93, 0.25000000000000006],
        [138, 94, -0.4330127024898146],
        [139, 93, 0.4330127012946243],
        [139, 94, 0.2500000000000001],
        [140, 95, 0.5000000000000001],
        [129, 102, 0.25000000000000006],
        [129, 103, -0.4330127024898146],
        [130, 102, 0.4330127012946243],
        [130, 103, 0.2500000000000001],
        [131, 104, 0.5000000000000001],
        [123, 78, 0.5],
        [123, 79, -0.866025404979629],
        [124, 78, 0.8660254025892484],
        [124, 79, 0.5000000000000001],
        [125, 80, 1.0],
        [114, 87, 0.5],
        [114, 88, -0.866025404979629],
        [115, 87, 0.8660254025892484],
        [115, 88, 0.5000000000000001],
        [116, 89, 1.0],
        [141, 96, 0.5],
        [141, 97, -0.866025404979629],
        [142, 96, 0.8660254025892484],
        [142, 97, 0.5000000000000001],
        [143, 98, 1.0],
        [132, 105, 0.5],
        [132, 106, -0.866025404979629],
        [133, 105, 0.8660254025892484],
        [133, 106, 0.5000000000000001],
        [134, 107, 1.0],
        [81, 108, 0.25],
        [81, 109, -0.4330127024898145],
        [82, 108, 0.4330127012946242],
        [82, 109, 0.25000000000000006],
        [83, 110, 0.5],
        [72, 117, 0.25],
        [72, 118, -0.4330127024898145],
        [73, 117, 0.4330127012946242],
        [73, 118, 0.25000000000000006],
        [74, 119, 0.5],
        [99, 126, 0.25],
        [99, 127, -0.4330127024898145],
        [100, 126, 0.4330127012946242],
        [100, 127, 0.25000000000000006],
        [101, 128, 0.5],
        [90, 135, 0.25],
        [90, 136, -0.4330127024898145],
        [91, 135, 0.4330127012946242],
        [91, 136, 0.25000000000000006],
        [92, 137, 0.5],
        [81, 111, -0.4330127024898145],
        [81, 112, 0.7500000020701304],
        [82, 111, -0.7500000000000001],
        [82, 112, -0.4330127024898146],
        [83, 113, -0.866025404979629],
        [72, 120, -0.4330127024898145],
        [72, 121, 0.7500000020701304],
        [73, 120, -0.7500000000000001],
        [73, 121, -0.4330127024898146],
        [74, 122, -0.866025404979629],
        [99, 129, -0.4330127024898145],
        [99, 130, 0.7500000020701304],
        [100, 129, -0.7500000000000001],
        [100, 130, -0.4330127024898146],
        [101, 131, -0.866025404979629],
        [90, 138, -0.4330127024898145],
        [90, 139, 0.7500000020701304],
        [91, 138, -0.7500000000000001],
        [91, 139, -0.4330127024898146],
        [92, 140, -0.866025404979629],
        [84, 108, 0.4330127012946242],
        [84, 109, -0.7500000000000001],
        [85, 108, 0.7499999979298698],
        [85, 109, 0.4330127012946243],
        [86, 110, 0.8660254025892484],
        [75, 117, 0.4330127012946242],
        [75, 118, -0.7500000000000001],
        [76, 117, 0.7499999979298698],
        [76, 118, 0.4330127012946243],
        [77, 119, 0.8660254025892484],
        [102, 126, 0.4330127012946242],
        [102, 127, -0.7500000000000001],
        [103, 126, 0.7499999979298698],
        [103, 127, 0.4330127012946243],
        [104, 128, 0.8660254025892484],
        [93, 135, 0.4330127012946242],
        [93, 136, -0.7500000000000001],
        [94, 135, 0.7499999979298698],
        [94, 136, 0.4330127012946243],
        [95, 137, 0.8660254025892484],
        [84, 111, 0.25000000000000006],
        [84, 112, -0.4330127024898146],
        [85, 111, 0.4330127012946243],
        [85, 112, 0.2500000000000001],
        [86, 113, 0.5000000000000001],
        [75, 120, 0.25000000000000006],
        [75, 121, -0.4330127024898146],
        [76, 120, 0.4330127012946243],
        [76, 121, 0.2500000000000001],
        [77, 122, 0.5000000000000001],
        [102, 129, 0.25000000000000006],
        [102, 130, -0.4330127024898146],
        [103, 129, 0.4330127012946243],
        [103, 130, 0.2500000000000001],
        [104, 131, 0.5000000000000001],
        [93, 138, 0.25000000000000006],
        [93, 139, -0.4330127024898146],
        [94, 138, 0.4330127012946243],
        [94, 139, 0.2500000000000001],
        [95, 140, 0.5000000000000001],
        [87, 114, 0.5],
        [87, 115, -0.866025404979629],
        [88, 114, 0.8660254025892484],
        [88, 115, 0.5000000000000001],
        [89, 116, 1.0],
        [78, 123, 0.5],
        [78, 124, -0.866025404979629],
        [79, 123, 0.8660254025892484],
        [79, 124, 0.5000000000000001],
        [80, 125, 1.0],
        [105, 132, 0.5],
        [105, 133, -0.866025404979629],
        [106, 132, 0.8660254025892484],
        [106, 133, 0.5000000000000001],
        [107, 134, 1.0],
        [96, 141, 0.5],
        [96, 142, -0.866025404979629],
        [97, 141, 0.8660254025892484],
        [97, 142, 0.5000000000000001],
        [98, 143, 1.0],
    ]
    row = [v[0] for v in array_ref]
    col = [v[1] for v in array_ref]
    data = [v[2] for v in array_ref]
    N = len(cell)
    coo_array_ref = coo_array(
        (data, (row, col)), shape=(N**2 * 9, N**2 * 9), dtype="double"
    )
    np.testing.assert_array_almost_equal(coo_array_ref.toarray(), reps.toarray())
